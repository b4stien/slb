<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Visualisator</title>

  <link rel="stylesheet" href ="css/bootstrap.css">
  <link rel="stylesheet" href ="css/visualisator.css">

  <!-- Dependencies -->
  <script type="text/javascript" src="js/libs/jquery.js"></script>
  <script type="text/javascript" src="js/libs/underscore.js"></script>
  <script type="text/javascript" src="js/libs/bootstrap.js"></script>
  <script type="text/javascript" src="js/libs/backbone.js"></script>
  <script type="text/javascript" src="js/libs/moment.js"></script>

  <!-- Application -->
  <script type="text/javascript" src="js/objects.js"></script>
  <script type="text/javascript" src="js/views.js"></script>
  <script type="text/javascript" src="js/app.js"></script>

  <style>
  table.family td, table.family th{
    vertical-align: middle!important;
    text-align: center;
  }
  .test-status {
    font-weight: bold;
  }
  .test-timestamp {
    display: block;
    font-size: 0.8em;
  }
  </style>
</head>

<body>

<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
  <div class="container">
    <a class="navbar-brand" href="#">Visualisator</a>
    <div class="navbar-form navbar-right">
      <div class="form-group">
        <select class="form-control" id="family-selector"></select>
      </div>
    </div>
  </div>
</nav>

<div class="container" id="main">
</div>

<script type="text/javascript">
window.currentPathURL = window.location.href.split('/').slice(0, -1).join('/');
window.visualisatorConfigURL = [currentPathURL, 'visualisatorConfig.json'].join('/');

window.families = [];
window.familyViews = {};
window.tools = {};

window.showCurrentFamily = function() {
  var currentFamilyUID = $('#family-selector').val(),
      currentFamilyView = window.familyViews[currentFamilyUID];

  _.each(_.values(window.familyViews), function(familyView) {
    familyView.$.hide();
  });

  currentFamilyView.$.show();
}

$(document).ready(function() {
  window.visualisatorConfig = Utils.getJSONFile(visualisatorConfigURL);
  window.mainConfig = Utils.getJSONFile(window.visualisatorConfig.mainConfigPath);

  _.each(window.mainConfig.families, function(rawFamily) {
    var family = new Family();
    family.set('tests', rawFamily.orderedTests);
    family.set('name', rawFamily.name);

    _.each(rawFamily.serialNumbers, function(sn) {
      var tool = new Tool({sn: sn, tests: rawFamily.orderedTestIDs});
      family.tools.add(tool);
      window.tools[sn] = tool;
    });

    window.families.push(family);
  });

  var mats = Utils.getCSVFile(window.visualisatorConfig.matsLog);
  _.each(mats, function(mat) {
    if(_.has(window.tools, mat[2])) {
      window.tools[mat[2]].parseMat(mat);
    }
  });

  var tfls = Utils.getCSVFile(window.visualisatorConfig.tflsLog);
  _.each(tfls, function(tfl) {
    if(_.has(window.tools, tfl[2])) {
      window.tools[tfl[2]].parseTfl(tfl);
    }
  });

  _.each(window.families, function(family) {
    var familyUID = _.uniqueId('family_'),
        jQel = $('<div id="' + familyUID +'" style="display: none;"></div>'),
        jQoption = $('<option value="' + familyUID + '">' + family.get('name') + '</option>'),
        familyView = new FamilyView(jQel, family);

    window.familyViews[familyUID] = familyView;

    $('#family-selector').append(jQoption);

    familyView.render();
    $('#main').append(jQel);
  });

  $('#family-selector').on('change', window.showCurrentFamily);

  window.showCurrentFamily();
});
</script>

</body>

</html>
